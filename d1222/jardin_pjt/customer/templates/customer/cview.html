{% extends "base.html" %}
{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css" integrity="sha512-10/jx2EXwxxWqCLX/hHth/vu2KY3jCF70dCQB8TSgNjbCVAC/8vai53GfMDrO2Emgwccf2pJqxct9ehpzG+MTw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock %}
{% block css-block %}
<style>
	a{
		cursor: pointer;
	}
</style>
{% endblock %}
{% block body-block %}

<div id="allwrap">
<div id="wrap">
	<!-- container -->
	<div id="container">
		<div id="location">
			<ol>
				<li><a href="#">HOME</a></li>
				<li><a href="#">CUSTOMER</a></li>
				<li class="last">NOTICE</li>
			</ol>
		</div>
		
		<div id="outbox">		
			<div id="left">
				<div id="title2">CUSTOMER<span>고객센터</span></div>
				<ul>	
					<li><a href="#" id="leftNavi1">NOTICE</a></li>
					<li><a href="#" id="leftNavi2">1:1문의</a></li>
					<li><a href="#" id="leftNavi3">FAQ</span></a></li>
					<li class="last"><a href="#" id="leftNavi4">이용안내</a></li>
				</ul>			
			</div><script type="text/javascript">//initSubmenu(1,0);</script>


			<!-- contents -->
			<div id="contents">
				<div id="customer">
					<h2><strong>NOTICE</strong><span>쟈뎅샵 소식을 전해드립니다.</span></h2>
					<script>
						$(function(){
							$("#likes_icon").click(function(){
								$.ajax({
									url:'/customer/clikes/',
									type:'post',
									headers:{'X-CSRFToken':'{{csrf_token}}'},
									data:{'bno':'{{c.bno}}'},
									dataType:'json',
									success:function(data){
										let dataHtml;
										if(data.like_chk == "1"){	//추가
											dataHtml = `<i class="fa-solid fa-heart"></i> (${data.count})`
										}else{				//삭제
											dataHtml = `<i class="fa-regular fa-heart"></i> (${data.count})`
										}
										$('#likes_icon').html(dataHtml);
									},
									error:function(xhr,errMsg,err){
										alert("서버 실패:"+errMsg);
									}
								})
							})
						})
					</script>
					<div class="viewDivMt">
						<div class="viewHead">
							<div class="subject">
								<ul>
									<li>{{c.btitle}}</li>
									<li style="padding-left: 500px;">
										좋아요 : <a id="likes_icon">
											{% if c.member in c.likes.all %}
											<i class="fa-solid fa-heart"></i> ({{c.likes.count}})
											{% else %}
											<i class="fa-regular fa-heart"></i> ({{c.likes.count}})
											{% endif %}
										</a>
									</li>
								</ul>
							</div>
							<div class="day">
								<p class="txt">작성일<span>{{c.bdate|date:'Y-m-d H:i:s'}}</span></p>
							</div>
						</div>

						<div class="viewContents">
							{{c.bcontent}}
						</div>
					</div>


					<!-- 이전다음글 -->
					<div class="pnDiv web">
						<table summary="이전다음글을 선택하여 보실 수 있습니다." class="preNext" border="1" cellspacing="0">
							<caption>이전다음글</caption>
							<colgroup>
							<col width="100px" />
							<col width="*" />
							</colgroup>
							<tbody>
								<tr>
									<th class="pre">PREV</th>
									{% if pre_c %}
									<td><a href="/customer/cview/{{pre_c.bno}}/">{{pre_c.btitle}}</a></td>
									{% else %}
									<td>이전 글이 없습니다.</td>
									{% endif %}
								</tr>

								<tr>
									<th class="next">NEXT</th>
									{% if next_c %}
									<td><a href="/customer/cview/{{next_c.bno}}/">{{next_c.btitle}}</a></td>
									{% else %}
									<td>다음 글이 없습니다.</td>
									{% endif %}
								</tr>
							</tbody>
						</table>
					</div>
					<!-- //이전다음글 -->

					<!-- 댓글-->
					<script>
						function colist(co){
							let html="";
							//댓글 총 개수
							$(".co_count").text(co.length);
							for(let i=0; i<co.length; i++){
								html+=`<ul id="${co[i].cno}">
									<li class="name">${co[i].member_id} <span>[${moment(co[i].cdate).format('YYYY-MM-DD HH:mm:ss')}]</span></li>
									<li class="txt">${co[i].ccontent}</li>
									<li class="btn">
										<a class="rebtn updateBtn">수정</a>
										<a class="rebtn deleteBtn">삭제</a>
									</li>
								</ul>`;
							}
							//하단댓글 리스트 위치에 추가
							$(".replyBox").html(html);
						}
						$(function(){
							$(document).on('click','.replyBtn',function(){
								data = $("#cofrm").serialize();
								csrfToken='{{csrf_token}}';
								$.ajax({
									url:'/comment/cowrite/',
									headers:{'X-CSRFToken':csrfToken},
									type:'post',
									dataType:'json',
									data:data,
									success:function(data){
										if(data.result=="success"){
											alert("댓글을 등록합니다.");
											let co = data.co;
											console.log(co);
											colist(co);
											//$(".replyBox").prepend(html);
										}else{
											alert("댓글 등록에 실패하였습니다.");
										}
									},
									error:function(xhr,errMsg,err){
										alert(errMsg);
									}
								});
							});
							$(document).on('click','.deleteBtn',function(){
								if(confirm("댓글을 삭제하시겠습니까?")){
									data = $("#cofrm").serialize();
									let cno = $(this).closest("ul").attr("id");
									csrfToken='{{csrf_token}}';
									$.ajax({
										url:'/comment/codelete/',
										headers:{'X-CSRFToken':csrfToken},
										type:'post',
										dataType:'json',
										data:{
											'cno':cno,
											'bno':'{{c.bno}}'
										},
										success:function(data){
											if(data.result=="success"){
												alert("댓글을 삭제합니다.");
												let co = data.co;
												colist(co);
											}else{
												alert("댓글 삭제에 실패하였습니다.");
											}
										},
										error:function(xhr,errMsg,err){
											alert(errMsg);
										}
									});
								}
							});
						});
					</script>
					<div class="replyWrite">
						<form id="cofrm">
						{% csrf_token %}
						<ul>
							<li class="in">
								<input type="hidden" name="bno" value="{{c.bno}}">
								<p class="txt">총 <span class="orange co_count">{{ comment_qs.count }}</span> 개의 댓글이 달려있습니다.</p>
								<p class="password">비밀번호&nbsp;&nbsp;<input type="password" name="cpw" class="replynum" /></p>
								<textarea class="replyType" name="ccontent"></textarea>
							</li>
							<li class="btn"><a class="replyBtn">등록</a></li>
						</ul>
						<p class="ntic">※ 비밀번호를 입력하시면 댓글이 비밀글로 등록 됩니다.</p>
						</form>
					</div>

					<div class="replyBox">
						{% for co in comment_qs %}
						<ul id="{{co.cno}}">
							<li class="name">{{co.member.id}} <span>[{{co.cdate|date:'Y-m-d H:i:s'}}]</span></li>
							<li class="txt">{{co.ccontent}}</li>
							<li class="btn">
								<a class="rebtn updateBtn">수정</a>
								<a class="rebtn deleteBtn">삭제</a>
							</li>
						</ul>
						{% endfor %}
						<!-- 수정폼, 비밀글 -->
						{% comment %} <ul>
							<li class="name">jjabcde <span>[2014-03-04&nbsp;&nbsp;15:01:59]</span></li>
							<li class="txt"><textarea class="replyType"></textarea></li>
							<li class="btn">
								<a href="#" class="rebtn">수정</a>
								<a href="#" class="rebtn">삭제</a>
							</li>
						</ul>
						<ul>
							<li class="name">jjabcde <span>[2014-03-04&nbsp;&nbsp;15:01:59]</span></li>
							<li class="txt">
								<a href="password.html" class="passwordBtn"><span class="orange">※ 비밀글입니다.</span></a>
							</li>
						</ul> {% endcomment %}
						<!-- 수정폼, 비밀글 -->
					</div>
					<!-- //댓글 -->


					<!-- Btn Area -->
					<div class="btnArea btline">
						<div class="bRight">
							<ul>
								<li><a href="/customer/clist/" class="sbtnMini mw">목록</a></li>
								<li><a href="#" class="sbtnMini mw">답글</a></li>
								<li><a href="#" class="sbtnMini mw">수정</a></li>
								<li><a href="#" class="sbtnMini mw">삭제</a></li>
							</ul>
						</div>
					</div>
					<!-- //Btn Area -->
				</div>
			</div>
			<!-- //contents -->
		</div>
	</div>
	<!-- //container -->
</div>
</div>
{% endblock %}